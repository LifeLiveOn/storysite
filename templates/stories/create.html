{% extends 'stories/base.html' %}
{% load static %}
{% block alternate-style %}
    <link href="{% static 'css/create.css' %}" rel="stylesheet">
    <link href="{% static 'css/register.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
    <div class="legend text-center mt-5 py-5 text-white"
         style="height:500px;object-fit: scale-down ; background-image: url('/media/images/background.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; background-blend-mode: darken; color: #fff;">
        <h2><i class="fa fa-pencil-alt" aria-hidden="true"></i> Leave Your Mark: Contribute Your Unique Story</h2>
        <br>
    </div>
    <div class="content w-75 p3">
        <form id="storyForm" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label for="id_story_name" class="form-label">Story Title</label>
                <input type="text" class="form-control" name="story_name" maxlength="255" required=""
                       id="id_story_name" placeholder="Enter your story title">
            </div>
            <div class="form-group">
                <label for="id_story_description" class="form-label">Description</label>
                <textarea name="story_description" class="form-control" cols="40" rows="10" maxlength="500"
                          required="" id="id_story_description" placeholder="What's your story about?"></textarea>
            </div>
            <div class="form-group">
                <label for="id_is_valid" class="form-label">Is this verify?</label>
                <input type="checkbox" class="form-check-input" name="is_valid" id="id_is_valid">
            </div>
            <div class="form-group">
                <label class="form-label">Insert story image</label>
                <input type="file" class="form-control" name="story_image" id="story_image" accept=".jpg, .jpeg, .png">
                <input type="hidden" name="cartoon_image" id="cartoon_image">
            </div>
            <div id="image_wrapper">
                <canvas id="originalCanvas" style="display: none;"></canvas>
                <canvas id="cartoonCanvas"></canvas>
            </div>
            <button type="button" id="saveButton" class="btn btn-primary">Apply Cartoon Effect</button>
            <button type="submit" value="Submit" class="btn btn-primary">Submit</button>
        </form>
    </div>
    <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
    <script src="{% static 'script/pasteclip.js' %}"></script>
    <script>
        document.getElementById('story_image').addEventListener('change', function (e) {
            let file = e.target.files[0];
            let reader = new FileReader();

            reader.onload = function (event) {
                let img = new Image();
                img.onload = function () {
                    let originalCanvas = document.getElementById('originalCanvas');
                    let ctx = originalCanvas.getContext('2d');
                    originalCanvas.width = img.width;
                    originalCanvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('saveButton').addEventListener('click', function () {
            let originalCanvas = document.getElementById('originalCanvas');
            let cartoonCanvas = document.getElementById('cartoonCanvas');
            let src = cv.imread(originalCanvas);
            let dst = new cv.Mat();
            cv.cvtColor(src, src, cv.COLOR_RGBA2RGB, 0);

            cv.bilateralFilter(src, dst, 9, 75, 75, cv.BORDER_DEFAULT);
            cv.cvtColor(dst, dst, cv.COLOR_RGB2GRAY, 0);
            cv.medianBlur(dst, dst, 7);
            cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_MEAN_C, cv.THRESH_BINARY, 9, 2);
            cv.cvtColor(dst, dst, cv.COLOR_GRAY2RGB, 0);
            cv.bitwise_and(src, dst, dst);

            // Resize the cartoonized image
            let desiredWidth = 800;
            let aspectRatio = dst.rows / dst.cols;
            let newSize = new cv.Size(desiredWidth, Math.round(desiredWidth * aspectRatio));
            cv.resize(dst, dst, newSize, 0, 0, cv.INTER_AREA);

            cv.imshow('cartoonCanvas', dst);
            src.delete();
            dst.delete();

            cartoonCanvas.toBlob(function (blob) {
                let reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = function () {
                    let base64data = reader.result;
                    document.getElementById('cartoon_image').value = base64data;
                }
            }, 'image/png', 0.8);
        });
    </script>
{% endblock %}
